<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payment ‚Ä¢ Bus Reservation</title>
    <style>
        :root { 
            --bg:#0f172a; 
            --muted:#94a3b8; 
            --text:#e5e7eb; 
            --primary:#22c55e; 
            --primary-600:#16a34a; 
            --input:#1f2937; 
            --ring:rgba(34,197,94,.35); 
            --card:#111827;
            --danger:#ef4444;
            --danger-600:#dc2626;
            --warning:#f59e0b;
            --warning-600:#d97706;
        }
        html,body{height:100%}
        body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;color:var(--text);background:linear-gradient(0deg,#0b1220,var(--bg));}
        .container{max-width:800px;margin:24px auto;padding:0 16px}
        .h1{font-size:22px;margin:16px 0;text-align:center}
        .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:20px;margin-bottom:16px}
        .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
        .label{color:var(--muted);font-size:14px}
        .value{font-weight:600}
        .total{font-size:18px;color:var(--primary);border-top:1px solid rgba(148,163,184,.15);padding-top:12px;margin-top:12px}
        .form{display:grid;gap:16px}
        .input{padding:12px 14px;border-radius:10px;border:1px solid rgba(148,163,184,.25);background:var(--input);color:var(--text);outline:none}
        .input:focus{box-shadow:0 0 0 4px var(--ring);border-color:var(--primary)}
        .button{appearance:none;border:0;padding:12px 16px;border-radius:10px;background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff;font-weight:600;cursor:pointer;width:100%}
        .button:disabled{background:#6b7280;cursor:not-allowed}
        .link{color:var(--primary);text-decoration:none}
        .link:hover{text-decoration:underline}
        .meta{color:var(--muted);text-align:center;margin-top:16px}
        .payment-methods{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
        .payment-option{display:flex;align-items:center;padding:12px;border:2px solid rgba(148,163,184,.25);border-radius:10px;cursor:pointer;transition:all 0.2s}
        .payment-option:hover{border-color:var(--primary)}
        .payment-option.selected{border-color:var(--primary);background:rgba(34,197,94,.1)}
        .payment-option input[type="radio"]{margin-right:8px;accent-color:var(--primary)}
        .payment-icon{font-size:24px;margin-right:8px}
        .loading{text-align:center;padding:20px;color:var(--muted)}
        .error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:12px;border-radius:8px;margin-bottom:16px}
        .success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac;padding:12px;border-radius:8px;margin-bottom:16px}
        
        /* Success Modal Styles */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
        .modal.show{display:flex}
        .modal-content{background:#ffffff;border-radius:16px;padding:32px;max-width:500px;width:90%;text-align:center;color:#0f172a;box-shadow:0 20px 25px -5px rgba(0,0,0,.1)}
        .success-icon{font-size:64px;color:#22c55e;margin-bottom:16px}
        .modal-title{font-size:24px;font-weight:700;margin-bottom:8px;color:#0f172a}
        .modal-subtitle{color:#6b7280;margin-bottom:24px;font-size:16px}
        .booking-details{background:#f8fafc;border-radius:12px;padding:20px;margin:20px 0;text-align:left}
        .booking-detail-row{display:flex;justify-content:space-between;margin-bottom:8px}
        .booking-detail-label{color:#6b7280;font-size:14px}
        .booking-detail-value{font-weight:600;color:#0f172a}
        .modal-buttons{display:flex;gap:12px;justify-content:center;margin-top:24px}
        .modal-button{appearance:none;border:0;padding:12px 24px;border-radius:10px;font-weight:600;cursor:pointer;font-size:14px;transition:all 0.2s}
        .modal-button.primary{background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#ffffff}
        .modal-button.secondary{background:#f1f5f9;color:#475569;border:1px solid #e2e8f0}
        .modal-button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .countdown{color:#6b7280;font-size:14px;margin-top:16px}
    </style>
</head>
<body>
    <div class="container">
        <h1 class="h1">Payment</h1>
        
        <div id="messageContainer"></div>
        
        <!-- Booking Summary -->
        <div class="card">
            <h3 style="margin-top:0">Booking Summary</h3>
            <div id="bookingSummary"></div>
        </div>
        
        <!-- Payment Method Selection -->
        <div class="card">
            <h3 style="margin-top:0">Select Payment Method</h3>
            <div class="payment-methods">
                <label class="payment-option" id="visaOption">
                    <input type="radio" name="paymentMethod" value="Visa" required>
                    <span class="payment-icon">üí≥</span>
                    <span>Visa</span>
                </label>
                <label class="payment-option" id="mastercardOption">
                    <input type="radio" name="paymentMethod" value="Mastercard" required>
                    <span class="payment-icon">üí≥</span>
                    <span>Mastercard</span>
                </label>
            </div>
        </div>
        
        <!-- Payment Form -->
        <div class="card">
            <h3 style="margin-top:0">Payment Details</h3>
            <form class="form" id="paymentForm">
                <div>
                    <label class="label">Card Number</label>
                    <input type="text" class="input" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required />
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div>
                        <label class="label">Expiry Date</label>
                        <input type="text" class="input" id="expiryDate" placeholder="MM/YY" maxlength="5" required />
                    </div>
                    <div>
                        <label class="label">CVV</label>
                        <input type="text" class="input" id="cvv" placeholder="123" maxlength="4" required />
                    </div>
                </div>
                <button type="submit" class="button" id="payButton" disabled>Complete Payment</button>
            </form>
        </div>
        
        <div class="meta">
            <a class="link" href="checkout.html">Back to Checkout</a>
        </div>
    </div>

    <!-- Booking Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="success-icon">üéâ</div>
            <h2 class="modal-title">Booking Successful!</h2>
            <p class="modal-subtitle">Your bus reservation has been confirmed</p>
            
            <div class="booking-details">
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Booking ID:</span>
                    <span class="booking-detail-value" id="modalBookingId">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Passenger:</span>
                    <span class="booking-detail-value" id="modalPassengerName">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Route:</span>
                    <span class="booking-detail-value" id="modalRoute">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Date & Time:</span>
                    <span class="booking-detail-value" id="modalDateTime">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Total Amount:</span>
                    <span class="booking-detail-value" id="modalAmount">-</span>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-button primary" id="downloadTicketBtn">
                    üìÑ Download E-Ticket
                </button>
                <button class="modal-button secondary" id="goHomeBtn">
                    üè† Go to Home
                </button>
            </div>
            
            <div class="countdown" id="countdown">
                Redirecting to home in <span id="countdownNumber">10</span> seconds...
            </div>
        </div>
    </div>

    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        let passengerData = {};
        let paymentData = {};
        let selectedPaymentMethod = '';

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        function loadData() {
            try {
                passengerData = JSON.parse(localStorage.getItem('passengerData') || '{}');
                paymentData = JSON.parse(localStorage.getItem('paymentData') || '{}');
                
                if (!passengerData.firstName || !paymentData.schedule) {
                    showMessage('Missing booking data. Please go back to checkout.', 'error');
                    return;
                }
                
                displayBookingSummary();
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('Error loading booking data', 'error');
            }
        }

        function displayBookingSummary() {
            const summary = document.getElementById('bookingSummary');
            const schedule = paymentData.schedule;
            const totalPrice = schedule.fare ? 
                (parseFloat(schedule.fare) * (paymentData.count || 1)).toFixed(2) : '0.00';
            
            summary.innerHTML = `
                <div class="row">
                    <span class="label">Passenger:</span>
                    <span class="value">${passengerData.firstName} ${passengerData.lastName}</span>
                </div>
                <div class="row">
                    <span class="label">Email:</span>
                    <span class="value">${passengerData.email}</span>
                </div>
                <div class="row">
                    <span class="label">Phone:</span>
                    <span class="value">${passengerData.phone}</span>
                </div>
                <div class="row">
                    <span class="label">NIC:</span>
                    <span class="value">${passengerData.nic}</span>
                </div>
                <div class="row">
                    <span class="label">Route:</span>
                    <span class="value">${schedule.route?.fromStand || 'N/A'} ‚Üí ${schedule.route?.toStand || 'N/A'}</span>
                </div>
                <div class="row">
                    <span class="label">Date:</span>
                    <span class="value">${schedule.travelDate || 'N/A'}</span>
                </div>
                <div class="row">
                    <span class="label">Time:</span>
                    <span class="value">${schedule.startTime || 'N/A'} - ${schedule.endTime || 'N/A'}</span>
                </div>
                <div class="row">
                    <span class="label">Bus:</span>
                    <span class="value">${schedule.bus?.registrationNo || 'N/A'}</span>
                </div>
                <div class="row">
                    <span class="label">Tickets:</span>
                    <span class="value">${paymentData.count || 1}</span>
                </div>
                <div class="row">
                    <span class="label">Fare per person:</span>
                    <span class="value">${schedule.fare ? 'Rs. ' + schedule.fare : 'N/A'}</span>
                </div>
                <div class="row total">
                    <span class="label">Total Amount:</span>
                    <span class="value">Rs. ${totalPrice}</span>
                </div>
            `;
        }

        function setupEventListeners() {
            // Payment method selection
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedPaymentMethod = e.target.value;
                    updatePaymentOptionStyles();
                    updatePayButton();
                });
            });

            // Card number formatting
            document.getElementById('cardNumber').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
                updatePayButton();
            });

            // Expiry date formatting
            document.getElementById('expiryDate').addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
                updatePayButton();
            });

            // CVV formatting
            document.getElementById('cvv').addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                updatePayButton();
            });


            // Form submission
            document.getElementById('paymentForm').addEventListener('submit', handlePayment);
        }

        function updatePaymentOptionStyles() {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            if (selectedPaymentMethod === 'Visa') {
                document.getElementById('visaOption').classList.add('selected');
            } else if (selectedPaymentMethod === 'Mastercard') {
                document.getElementById('mastercardOption').classList.add('selected');
            }
        }

        function updatePayButton() {
            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expiryDate = document.getElementById('expiryDate').value;
            const cvv = document.getElementById('cvv').value;
            
            const isValid = selectedPaymentMethod && 
                          cardNumber.length >= 16 && 
                          expiryDate.length === 5 && 
                          cvv.length >= 3;
            
            document.getElementById('payButton').disabled = !isValid;
        }

        async function handlePayment(e) {
            e.preventDefault();
            
            if (!selectedPaymentMethod) {
                showMessage('Please select a payment method', 'error');
                return;
            }

            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            
            // Show processing message
            showMessage('Processing your payment...', 'success');

            try {
                // Create booking first (without payment - will be created separately)
                const bookingData = {
                    firstName: passengerData.firstName,
                    lastName: passengerData.lastName,
                    phone: passengerData.phone,
                    email: passengerData.email,
                    nic: passengerData.nic,
                    bookedTickets: paymentData.count || 1,
                    scheduleId: paymentData.schedule.scheduleId,
                    isOnlineBooking: true
                };
                
                const bookingResponse = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });
                
                if (!bookingResponse.ok) {
                    throw new Error('Failed to create booking');
                }
                
                const booking = await bookingResponse.json();
                
                // Create payment
                const totalPrice = paymentData.schedule.fare ? 
                    parseFloat(paymentData.schedule.fare) * (paymentData.count || 1) : 0;
                
                const paymentDataToStore = {
                    bookingId: booking.bookingId,
                    paymentMethod: selectedPaymentMethod,
                    paymentStatus: 'Paid',
                    totalPrice: totalPrice
                };
                
                const paymentResponse = await fetch('/api/payments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentDataToStore)
                });
                
                if (!paymentResponse.ok) {
                    throw new Error('Failed to create payment');
                }
                
                const payment = await paymentResponse.json();
                
                // Store booking confirmation
                const bookingConfirmation = {
                    ...paymentData,
                    passenger: passengerData,
                    booking: booking,
                    payment: payment,
                    bookingId: booking.bookingId,
                    bookingDate: new Date().toISOString().split('T')[0]
                };
                
                localStorage.setItem('bookingConfirmation', JSON.stringify(bookingConfirmation));
                
                // Clear temporary data
                localStorage.removeItem('passengerData');
                localStorage.removeItem('paymentData');
                
                // Show success modal
                showSuccessModal(booking, payment, bookingConfirmation);
                
            } catch (error) {
                console.error('Error processing payment:', error);
                showMessage('Payment failed: ' + error.message, 'error');
                payButton.disabled = false;
                payButton.textContent = 'Complete Payment';
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error' : 'success';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }
        }

        function showSuccessModal(booking, payment, bookingConfirmation) {
            // Populate modal with booking details
            document.getElementById('modalBookingId').textContent = booking.bookingId;
            document.getElementById('modalPassengerName').textContent = `${passengerData.firstName} ${passengerData.lastName}`;
            document.getElementById('modalRoute').textContent = `${paymentData.schedule.route?.fromStand || 'N/A'} ‚Üí ${paymentData.schedule.route?.toStand || 'N/A'}`;
            document.getElementById('modalDateTime').textContent = `${paymentData.schedule.travelDate || 'N/A'} at ${paymentData.schedule.startTime || 'N/A'}`;
            document.getElementById('modalAmount').textContent = `Rs. ${payment.totalPrice}`;
            
            // Show the modal
            const modal = document.getElementById('successModal');
            modal.classList.add('show');
            
            // Setup modal button event listeners
            setupModalButtons(booking, payment, bookingConfirmation);
            
            // Start countdown
            startCountdown();
        }

        function setupModalButtons(booking, payment, bookingConfirmation) {
            // Download ticket button
            document.getElementById('downloadTicketBtn').onclick = () => {
                generateConfirmationPDF(booking, payment, bookingConfirmation);
            };
            
            // Go home button
            document.getElementById('goHomeBtn').onclick = () => {
                window.location.href = 'index.html';
            };
        }

        function startCountdown() {
            let countdown = 10;
            const countdownElement = document.getElementById('countdownNumber');
            const countdownContainer = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    countdownContainer.style.display = 'none';
                    window.location.href = 'index.html';
                }
            }, 1000);
        }

        function generateConfirmationPDF(booking, payment, bookingConfirmation) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font
                doc.setFont("helvetica");
                
                // Header with company branding
                doc.setFillColor(34, 197, 94);
                doc.rect(0, 0, 210, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.text('üöå Bus Reservation', 20, 20);
                
                // E-Ticket title
                doc.setFontSize(18);
                doc.setTextColor(0, 0, 0);
                doc.text('E-TICKET', 20, 45);
                
                // Line separator
                doc.setDrawColor(34, 197, 94);
                doc.setLineWidth(1);
                doc.line(20, 50, 190, 50);
                
                // Booking details in a more ticket-like format
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Booking ID: ${booking.bookingId}`, 20, 65);
                doc.text(`Payment ID: ${payment.paymentId}`, 20, 75);
                doc.text(`Issue Date: ${bookingConfirmation.bookingDate}`, 20, 85);
                
                // Passenger Details Section
                doc.setFontSize(16);
                doc.setTextColor(34, 197, 94);
                doc.text('Passenger Details', 20, 90);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Name: ${passengerData.firstName} ${passengerData.lastName}`, 20, 105);
                doc.text(`Email: ${passengerData.email}`, 20, 115);
                doc.text(`Phone: ${passengerData.phone}`, 20, 125);
                doc.text(`NIC: ${passengerData.nic}`, 20, 135);
                
                // Trip Details Section
                doc.setFontSize(16);
                doc.setTextColor(34, 197, 94);
                doc.text('Trip Details', 20, 155);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                const schedule = paymentData.schedule;
                doc.text(`Route: ${schedule.route?.fromStand || 'N/A'} ‚Üí ${schedule.route?.toStand || 'N/A'}`, 20, 170);
                doc.text(`Date: ${schedule.travelDate || 'N/A'}`, 20, 180);
                doc.text(`Time: ${schedule.startTime || 'N/A'} - ${schedule.endTime || 'N/A'}`, 20, 190);
                doc.text(`Bus: ${schedule.bus?.registrationNo || 'N/A'}`, 20, 200);
                doc.text(`Tickets: ${paymentData.count || 1}`, 20, 210);
                
                // Payment Details Section
                doc.setFontSize(16);
                doc.setTextColor(34, 197, 94);
                doc.text('Payment Details', 20, 230);
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Payment Method: ${payment.paymentMethod}`, 20, 245);
                doc.text(`Payment Status: ${payment.paymentStatus}`, 20, 255);
                doc.text(`Total Amount: Rs. ${payment.totalPrice}`, 20, 265);
                
                // Check if we need a new page for Important Notes
                let currentY = 280;
                const pageHeight = 280; // A4 page height minus margins
                
                if (currentY > pageHeight - 100) {
                    doc.addPage();
                    currentY = 20;
                }
                
                // Important Notes Section
                doc.setFontSize(16);
                doc.setTextColor(239, 68, 68); // Red color for important notes
                doc.text('Important Notes', 20, currentY);
                currentY += 15;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const notes = [
                    '‚Ä¢ Please arrive at the bus station 15 minutes before departure time.',
                    '‚Ä¢ Bring a valid ID proof for verification.',
                    '‚Ä¢ Keep this confirmation document safe for your records.',
                    '',
                    'CANCELLATION POLICY:',
                    '‚Ä¢ To cancel your reservation and request a refund, please:',
                    '  1. Create a user account by registering on our system',
                    '  2. Login to your account',
                    '  3. Navigate to "My Bookings" section',
                    '  4. Select this booking and proceed with cancellation',
                    '‚Ä¢ Refund will be processed within 5-7 business days',
                    '‚Ä¢ Cancellation charges may apply as per policy'
                ];
                
                notes.forEach(note => {
                    // Check if we need a new page
                    if (currentY > pageHeight - 20) {
                        doc.addPage();
                        currentY = 20;
                    }
                    
                    doc.text(note, 20, currentY);
                    currentY += 8;
                });
                
                // Footer
                if (currentY > pageHeight - 30) {
                    doc.addPage();
                    currentY = 20;
                }
                
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text('Thank you for choosing our bus service!', 20, currentY);
                doc.text('For support, contact us at support@busreservation.com', 20, currentY + 10);
                
                // Save the PDF
                const fileName = `E-Ticket_${booking.bookingId}_${passengerData.firstName}_${passengerData.lastName}.pdf`;
                doc.save(fileName);
                
                // Show confirmation message (this will be overridden by the main success flow)
                console.log('PDF generated successfully');
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('Error generating confirmation document', 'error');
            }
        }
    </script>
</body>
</html>
