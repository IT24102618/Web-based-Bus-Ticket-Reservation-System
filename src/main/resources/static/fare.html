<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Fare • Bus Reservation</title>
    <style>
        :root { 
            --bg:#0f172a; 
            --muted:#94a3b8; 
            --text:#e5e7eb; 
            --primary:#22c55e; 
            --primary-600:#16a34a; 
            --input:#1f2937; 
            --ring:rgba(34,197,94,.35); 
            --card:#111827;
            --danger:#ef4444;
            --danger-600:#dc2626;
            --warning:#f59e0b;
            --warning-600:#d97706;
        }
        html,body{height:100%}
        body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;color:var(--text);background:linear-gradient(0deg,#0b1220,var(--bg));}
        .layout{display:flex;min-height:100vh}
        .sidebar{width:240px;background:#0c1324;border-right:1px solid rgba(148,163,184,.15);padding:16px;position:sticky;top:0;height:100vh}
        .brand{font-weight:800;margin:0 0 14px}
        .menu{list-style:none;padding:0;margin:0;display:grid;gap:8px}
        .menu a{display:block;color:#e5e7eb;text-decoration:none;padding:10px 12px;border-radius:10px}
        .menu a:hover{background:rgba(148,163,184,.12)}
        .menu a.active{background:rgba(34,197,94,.15);color:var(--primary)}
        .content{flex:1;padding:24px}
        .topbar{position:sticky;top:0;z-index:5;background:rgba(12,19,36,.85);backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.15);display:flex;justify-content:flex-end;align-items:center;padding:10px 16px;margin:-24px -24px 24px -24px}
        .button{appearance:none;border:0;padding:10px 12px;border-radius:10px;background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff;font-weight:600;cursor:pointer}
        .button.danger{background:linear-gradient(180deg,var(--danger),var(--danger-600))}
        .button.warning{background:linear-gradient(180deg,var(--warning),var(--warning-600))}
        .button.small{padding:6px 10px;font-size:12px}
        .h1{font-size:22px;margin:0 0 24px}
        .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:20px;margin-bottom:16px}
        .table{width:100%;border-collapse:collapse;margin-top:16px}
        .table th,.table td{padding:12px;text-align:left;border-bottom:1px solid rgba(148,163,184,.15)}
        .table th{background:rgba(148,163,184,.05);font-weight:600;color:var(--muted)}
        .table tr:hover{background:rgba(148,163,184,.05)}
        .input{padding:8px 10px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:var(--input);color:var(--text);outline:none;width:100px}
        .input:focus{box-shadow:0 0 0 2px var(--ring);border-color:var(--primary)}
        .actions{display:flex;gap:8px;align-items:center}
        .loading{text-align:center;padding:40px;color:var(--muted)}
        .error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:12px;border-radius:8px;margin-bottom:16px}
        .success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac;padding:12px;border-radius:8px;margin-bottom:16px}
        .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:var(--card);border-radius:12px;padding:24px;max-width:400px;width:90%;border:1px solid rgba(148,163,184,.15)}
        .modal h3{margin:0 0 16px}
        .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:20px}
        .hidden{display:none}
        .error{color:#ef4444;font-size:12px;margin-top:4px;display:block}
        .input.error{border-color:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,.2)}
        .input.success{border-color:#10b981;box-shadow:0 0 0 4px rgba(16,185,129,.2)}
        .validation-summary{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:12px;margin-bottom:16px;display:none}
        .validation-summary.show{display:block}
        .validation-summary ul{margin:0;padding-left:20px}
        .validation-summary li{color:#ef4444;font-size:14px;margin-bottom:4px}
    </style>
</head>
<body>
    <div class="topbar">
        <button id="signout" class="button">Sign out</button>
    </div>
    <div class="layout">
        <aside class="sidebar">
            <h2 class="brand">Finance</h2>
            <ul class="menu">
                <li><a href="fare.html">Manage Fare</a></li>
                <li><a href="refundmanagement.html">Refund Management</a></li>
                <li><a href="viewpaymenthistory.html">View Payment History</a></li>

            </ul>
        </aside>
        <main class="content">
            <h1 class="h1">Manage Fare</h1>
            
            <div id="messageContainer"></div>
            
            
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h3 style="margin:0">Scheduled Buses</h3>
                    <button id="refreshBtn" class="button small">Refresh</button>
                </div>
                
                <div id="loadingIndicator" class="loading">Loading schedules...</div>
                
                <table class="table hidden" id="schedulesTable">
                    <thead>
                        <tr>
                            <th>Schedule ID</th>
                            <th>Route</th>
                            <th>Bus</th>
                            <th>Bus Type</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Current Fare</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="schedulesTableBody">
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Set/Update Fare Modal -->
    <div id="updateModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle">Update Fare</h3>
            <div id="fareValidationSummary" class="validation-summary">
                <strong>Please fix the following errors:</strong>
                <ul id="fareValidationErrors"></ul>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:8px;color:var(--muted)">Fare Amount (Rs.)</label>
                <input type="number" id="newFareInput" class="input" placeholder="Enter fare amount" step="0.01" min="0">
                <span id="fareError" class="error"></span>
            </div>
            <div class="modal-actions">
                <button id="cancelUpdate" class="button warning">Cancel</button>
                <button id="confirmUpdate" class="button"><span id="confirmButtonText">Update Fare</span></button>
            </div>
        </div>
    </div>

    <!-- Delete Fare Modal -->
    <div id="deleteModal" class="modal hidden">
        <div class="modal-content">
            <h3>Delete Fare</h3>
            <p style="margin:0 0 16px;color:var(--muted)">Are you sure you want to remove the fare for this schedule? This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="cancelDelete" class="button warning">Cancel</button>
                <button id="confirmDelete" class="button danger">Delete Fare</button>
            </div>
        </div>
    </div>

    <script>
        let schedules = [];
        let currentScheduleId = null;

        // Load schedules on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSchedules();
            setupEventListeners();
            setupFareValidation();
        });

        // Validation functions
        function validateFareAmount(fare) {
            if (!fare || fare === '') {
                return 'Fare amount is required';
            }
            
            const fareNum = parseFloat(fare);
            if (isNaN(fareNum)) {
                return 'Please enter a valid number';
            }
            
            if (fareNum < 0) {
                return 'Fare amount cannot be negative';
            }
            
            if (fareNum === 0) {
                return 'Fare amount must be greater than 0';
            }
            
            if (fareNum > 10000) {
                return 'Fare amount cannot exceed Rs. 10,000';
            }
            
            // Check for reasonable decimal places (max 2)
            if (fare.toString().includes('.') && fare.toString().split('.')[1].length > 2) {
                return 'Fare amount can have maximum 2 decimal places';
            }
            
            return null;
        }

        function setupFareValidation() {
            const fareInput = document.getElementById('newFareInput');
            const fareError = document.getElementById('fareError');

            // Real-time validation on input
            fareInput.addEventListener('input', (e) => {
                // Prevent negative numbers by removing minus sign
                if (e.target.value.includes('-')) {
                    e.target.value = e.target.value.replace('-', '');
                }
                
                // Prevent more than 2 decimal places
                if (e.target.value.includes('.')) {
                    const parts = e.target.value.split('.');
                    if (parts[1] && parts[1].length > 2) {
                        e.target.value = parts[0] + '.' + parts[1].substring(0, 2);
                    }
                }
                
                validateFareField(fareInput, validateFareAmount, fareError);
            });

            // Validation on blur
            fareInput.addEventListener('blur', () => {
                validateFareField(fareInput, validateFareAmount, fareError);
            });

            // Prevent pasting negative numbers
            fareInput.addEventListener('paste', (e) => {
                setTimeout(() => {
                    if (e.target.value.includes('-')) {
                        e.target.value = e.target.value.replace('-', '');
                    }
                }, 0);
            });
        }

        function validateFareField(input, validator, errorElement) {
            const error = validator(input.value);
            if (error) {
                input.classList.add('error');
                input.classList.remove('success');
                errorElement.textContent = error;
            } else {
                input.classList.remove('error');
                input.classList.add('success');
                errorElement.textContent = '';
            }
        }

        function validateFareForm() {
            const fareInput = document.getElementById('newFareInput');
            const fareError = document.getElementById('fareError');
            const error = validateFareAmount(fareInput.value);
            
            if (error) {
                fareInput.classList.add('error');
                fareInput.classList.remove('success');
                fareError.textContent = error;
                
                // Show validation summary
                const validationSummary = document.getElementById('fareValidationSummary');
                const validationErrors = document.getElementById('fareValidationErrors');
                validationErrors.innerHTML = `<li>${error}</li>`;
                validationSummary.classList.add('show');
                
                return false;
            } else {
                fareInput.classList.remove('error');
                fareInput.classList.add('success');
                fareError.textContent = '';
                
                // Hide validation summary
                const validationSummary = document.getElementById('fareValidationSummary');
                validationSummary.classList.remove('show');
                
                return true;
            }
        }

        function clearFareValidationErrors() {
            const fareInput = document.getElementById('newFareInput');
            const fareError = document.getElementById('fareError');
            
            fareInput.classList.remove('error', 'success');
            fareError.textContent = '';
            
            // Hide validation summary
            const validationSummary = document.getElementById('fareValidationSummary');
            validationSummary.classList.remove('show');
        }

        function setupEventListeners() {
            document.getElementById('signout').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });

            document.getElementById('refreshBtn').addEventListener('click', loadSchedules);
            
            // Update fare modal
            document.getElementById('cancelUpdate').addEventListener('click', () => {
                document.getElementById('updateModal').classList.add('hidden');
                clearFareValidationErrors();
            });
            
            document.getElementById('confirmUpdate').addEventListener('click', updateFare);
            
            // Delete fare modal
            document.getElementById('cancelDelete').addEventListener('click', () => {
                document.getElementById('deleteModal').classList.add('hidden');
            });
            
            document.getElementById('confirmDelete').addEventListener('click', deleteFare);
        }

        async function loadSchedules() {
            try {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('schedulesTable').classList.add('hidden');
                
                const response = await fetch('/api/schedules');
                if (!response.ok) throw new Error('Failed to load schedules');
                
                schedules = await response.json();
                displaySchedules();
                
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('schedulesTable').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading schedules:', error);
                showMessage('Error loading schedules: ' + error.message, 'error');
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        function displaySchedules() {
            const tbody = document.getElementById('schedulesTableBody');
            tbody.innerHTML = '';

            if (schedules.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:40px">No schedules found</td></tr>';
                return;
            }

            schedules.forEach(schedule => {
                const row = document.createElement('tr');
                const route = schedule.route ? `${schedule.route.fromStand} → ${schedule.route.toStand}` : 'N/A';
                const bus = schedule.bus ? schedule.bus.registrationNo : 'N/A';
                const busType = schedule.bus ? schedule.bus.type : 'N/A';
                const fare = schedule.fare ? `Rs. ${schedule.fare}` : 'Not set';
                const fareClass = schedule.fare ? '' : 'style="color:var(--muted);font-style:italic"';
                
                row.innerHTML = `
                    <td>${schedule.scheduleId}</td>
                    <td>${route}</td>
                    <td>${bus}</td>
                    <td>${busType}</td>
                    <td>${schedule.travelDate || 'N/A'}</td>
                    <td>${schedule.startTime || 'N/A'} - ${schedule.endTime || 'N/A'}</td>
                    <td ${fareClass}>${fare}</td>
                    <td>
                        <div class="actions">
                            ${schedule.fare 
                                ? `<button onclick="openUpdateModal(${schedule.scheduleId})" class="button small">Update</button>
                                   <button onclick="openDeleteModal(${schedule.scheduleId})" class="button small danger">Delete</button>` 
                                : `<button onclick="openSetFareModal(${schedule.scheduleId})" class="button small">Set Fare</button>`
                            }
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        function openSetFareModal(scheduleId) {
            currentScheduleId = scheduleId;
            document.getElementById('newFareInput').value = '';
            document.getElementById('modalTitle').textContent = 'Set Fare';
            document.getElementById('confirmButtonText').textContent = 'Set Fare';
            clearFareValidationErrors();
            document.getElementById('updateModal').classList.remove('hidden');
        }

        function openUpdateModal(scheduleId) {
            currentScheduleId = scheduleId;
            const schedule = schedules.find(s => s.scheduleId === scheduleId);
            document.getElementById('newFareInput').value = schedule.fare || '';
            document.getElementById('modalTitle').textContent = 'Update Fare';
            document.getElementById('confirmButtonText').textContent = 'Update Fare';
            clearFareValidationErrors();
            document.getElementById('updateModal').classList.remove('hidden');
        }

        function openDeleteModal(scheduleId) {
            currentScheduleId = scheduleId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        async function updateFare() {
            // Validate form before submission
            if (!validateFareForm()) {
                return;
            }

            const newFare = document.getElementById('newFareInput').value;
            const isSettingNewFare = document.getElementById('modalTitle').textContent === 'Set Fare';

            try {
                const response = await fetch(`/api/schedules/${currentScheduleId}/fare`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fare: parseFloat(newFare) })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const successMessage = isSettingNewFare 
                    ? 'Fare set successfully!' 
                    : 'Fare updated successfully!';
                showMessage(successMessage, 'success');
                document.getElementById('updateModal').classList.add('hidden');
                loadSchedules();
            } catch (error) {
                console.error('Error updating fare:', error);
                const errorAction = isSettingNewFare ? 'setting' : 'updating';
                showMessage(`Error ${errorAction} fare: ${error.message}`, 'error');
            }
        }

        async function deleteFare() {
            try {
                const response = await fetch(`/api/schedules/${currentScheduleId}/fare`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                showMessage('Fare deleted successfully!', 'success');
                document.getElementById('deleteModal').classList.add('hidden');
                loadSchedules();
            } catch (error) {
                console.error('Error deleting fare:', error);
                showMessage('Error deleting fare: ' + error.message, 'error');
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error' : 'success';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
