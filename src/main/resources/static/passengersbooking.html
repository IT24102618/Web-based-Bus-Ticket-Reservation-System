<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passenger Bookings • Bus Reservation</title>
    <style>
        :root { 
            --bg:#0f172a; 
            --muted:#94a3b8; 
            --text:#e5e7eb; 
            --primary:#22c55e; 
            --primary-600:#16a34a; 
            --input:#1f2937; 
            --ring:rgba(34,197,94,.35); 
            --card:#111827;
            --danger:#ef4444;
            --danger-600:#dc2626;
            --warning:#f59e0b;
            --warning-600:#d97706;
            --info:#3b82f6;
            --info-600:#2563eb;
        }
        html,body{height:100%}
        body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;color:var(--text);background:linear-gradient(0deg,#0b1220,var(--bg));}
        .layout{display:flex;min-height:100vh}
        .sidebar{width:240px;background:#0c1324;border-right:1px solid rgba(148,163,184,.15);padding:16px;position:sticky;top:0;height:100vh}
        .brand{font-weight:800;margin:0 0 14px}
        .menu{list-style:none;padding:0;margin:0;display:grid;gap:8px}
        .menu a{display:block;color:#e5e7eb;text-decoration:none;padding:10px 12px;border-radius:10px}
        .menu a:hover{background:rgba(148,163,184,.12)}
        .menu a.active{background:rgba(34,197,94,.15);color:var(--primary)}
        .content{flex:1;padding:24px}
        .topbar{position:sticky;top:0;z-index:5;background:rgba(12,19,36,.85);backdrop-filter:blur(8px);border-bottom:1px solid rgba(148,163,184,.15);display:flex;justify-content:flex-end;align-items:center;padding:10px 16px;margin:-24px -24px 24px -24px}
        .button{appearance:none;border:0;padding:10px 12px;border-radius:10px;background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff;font-weight:600;cursor:pointer}
        .button.danger{background:linear-gradient(180deg,var(--danger),var(--danger-600))}
        .button.warning{background:linear-gradient(180deg,var(--warning),var(--warning-600))}
        .button.info{background:linear-gradient(180deg,var(--info),var(--info-600))}
        .button.small{padding:6px 10px;font-size:12px}
        .h1{font-size:22px;margin:0 0 24px}
        .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid rgba(148,163,184,.15);border-radius:14px;padding:20px;margin-bottom:16px}
        .table{width:100%;border-collapse:collapse;margin-top:16px}
        .table th,.table td{padding:12px;text-align:left;border-bottom:1px solid rgba(148,163,184,.15)}
        .table th{background:rgba(148,163,184,.05);font-weight:600;color:var(--muted)}
        .table tr:hover{background:rgba(148,163,184,.05)}
        .input{padding:8px 10px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:var(--input);color:var(--text);outline:none}
        .input:focus{box-shadow:0 0 0 2px var(--ring);border-color:var(--primary)}
        .actions{display:flex;gap:8px;align-items:center}
        .loading{text-align:center;padding:40px;color:var(--muted)}
        .error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5;padding:12px;border-radius:8px;margin-bottom:16px}
        .success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac;padding:12px;border-radius:8px;margin-bottom:16px}
        .hidden{display:none}
        .filter-bar{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
        .filter-select{padding:8px 12px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:var(--input);color:var(--text);outline:none}
        .booking-card{background:rgba(255,255,255,.02);border:1px solid rgba(148,163,184,.1);border-radius:8px;padding:16px;margin-bottom:12px}
        .booking-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .booking-id{font-weight:600;color:var(--primary)}
        .booking-status{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:500}
        .booking-status.confirmed{background:rgba(16,185,129,.2);color:#10b981}
        .booking-status.pending{background:rgba(245,158,11,.2);color:#f59e0b}
        .booking-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;color:var(--muted)}
        .booking-route{font-weight:500;color:var(--text)}
        .user-info{background:rgba(34,197,94,.05);border:1px solid rgba(34,197,94,.2);border-radius:8px;padding:12px;margin-bottom:12px}
        .user-name{font-weight:600;color:var(--primary);margin-bottom:4px}
        .user-details{font-size:12px;color:var(--muted)}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
        .user-box{background:rgba(255,255,255,.02);border:1px solid rgba(148,163,184,.1);border-radius:12px;padding:20px;margin-bottom:20px}
        .user-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid rgba(148,163,184,.1)}
        .user-name{font-size:18px;font-weight:600;color:var(--primary)}
        .user-email{font-size:14px;color:var(--muted)}
        .user-bookings{display:grid;gap:12px}
        .booking-item{background:rgba(255,255,255,.02);border:1px solid rgba(148,163,184,.1);border-radius:8px;padding:12px}
        .booking-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .booking-id{font-weight:600;color:var(--primary);font-size:14px}
        .booking-status{padding:2px 6px;border-radius:4px;font-size:11px;font-weight:500}
        .booking-status.confirmed{background:rgba(16,185,129,.2);color:#10b981}
        .booking-details{display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px;color:var(--muted)}
        .booking-route{font-weight:500;color:var(--text);font-size:13px}
        .booking-actions{display:flex;gap:8px;margin-top:8px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
        .form-group{margin-bottom:12px}
        .label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
        .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}
        .modal-content{background:var(--card);border:1px solid rgba(148,163,184,.15);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:18px;font-weight:600}
        .close-btn{background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer}
        .close-btn:hover{color:var(--text)}
        .select{padding:8px 10px;border-radius:6px;border:1px solid rgba(148,163,184,.25);background:var(--input);color:var(--text);outline:none}
        .select:focus{box-shadow:0 0 0 2px var(--ring);border-color:var(--primary)}
    </style>
</head>
<body>
    <div class="topbar">
        <button id="signout" class="button">Sign out</button>
    </div>
    <div class="layout">
        <aside class="sidebar">
            <h2 class="brand">Customer Service</h2>
            <ul class="menu">
                <li><a href="complainmanagement.html">Complaint Management</a></li>
                <li><a href="passengersbooking.html" class="active">Passenger Bookings</a></li>
            </ul>
        </aside>
        <main class="content">
            <h1 class="h1">Passenger Bookings</h1>
            
            <div id="messageContainer"></div>
            
            
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                    <h3 style="margin:0">All Passenger Bookings</h3>
                    <button id="refreshBtn" class="button small">Refresh</button>
                </div>
                
                <div class="filter-bar">
                    <input type="text" id="searchBox" class="input" placeholder="Search by user name, email, or booking ID..." style="flex:1;max-width:400px">
                    <button id="clearSearch" class="button small warning">Clear</button>
                </div>
                
                <div id="loadingIndicator" class="loading">Loading bookings...</div>
                
                <div id="bookingsContainer" class="hidden">
                    <!-- Bookings will be loaded here -->
                </div>
            </div>
        </main>
    </div>


    <script>
        let bookings = [];
        let users = [];
        let schedules = [];

        // Load bookings on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBookings();
            loadSchedules();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('signout').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            });

            document.getElementById('refreshBtn').addEventListener('click', loadBookings);
            
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', filterBookings);
            document.getElementById('clearSearch').addEventListener('click', clearSearch);
        }

        async function loadBookings() {
            try {
                document.getElementById('loadingIndicator').classList.remove('hidden');
                document.getElementById('bookingsContainer').classList.add('hidden');
                
                const response = await fetch('http://localhost:8080/api/bookings');
                if (!response.ok) throw new Error('Failed to load bookings');
                
                bookings = await response.json();
                await loadUsers();
                displayBookings();
                
                document.getElementById('loadingIndicator').classList.add('hidden');
                document.getElementById('bookingsContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading bookings:', error);
                showMessage('Error loading bookings: ' + error.message, 'error');
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('http://localhost:8080/api/users');
                if (response.ok) {
                    users = await response.json();
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadSchedules() {
            try {
                const response = await fetch('http://localhost:8080/api/schedules');
                if (response.ok) {
                    schedules = await response.json();
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }


        function displayBookings() {
            const container = document.getElementById('bookingsContainer');
            container.innerHTML = '';

            if (bookings.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px">No bookings found</div>';
                return;
            }

            // Group bookings by user email
            const bookingsByUser = {};
            bookings.forEach(booking => {
                const email = booking.email;
                if (!bookingsByUser[email]) {
                    bookingsByUser[email] = [];
                }
                bookingsByUser[email].push(booking);
            });

            // Create user boxes
            Object.keys(bookingsByUser).forEach(email => {
                const userBookings = bookingsByUser[email];
                const user = users.find(u => u.email === email);
                
                const userBox = document.createElement('div');
                userBox.className = 'user-box';
                
                const userHeader = document.createElement('div');
                userHeader.className = 'user-header';
                userHeader.innerHTML = `
                    <div>
                        <div class="user-name">${user ? `${user.firstName} ${user.lastName}` : email}</div>
                        <div class="user-email">${email}</div>
                    </div>
                    <div style="font-size:12px;color:var(--muted)">
                        ${user ? `Phone: ${user.phone || 'N/A'} | NIC: ${user.nic || 'N/A'}` : ''}
                    </div>
                `;
                
                const bookingsContainer = document.createElement('div');
                bookingsContainer.className = 'user-bookings';
                
                userBookings.forEach(booking => {
                    const schedule = booking.schedule || {};
                    const route = schedule.route || {};
                    const bus = schedule.bus || {};
                    
                    const bookingItem = document.createElement('div');
                    bookingItem.className = 'booking-item';
                    bookingItem.innerHTML = `
                        <div class="booking-header">
                            <span class="booking-id">Booking #${booking.bookingId}</span>
                            <span class="booking-status confirmed">Confirmed</span>
                        </div>
                        <div class="booking-details">
                            <div>
                                <div class="booking-route">${route.fromStand || 'N/A'} → ${route.toStand || 'N/A'}</div>
                                <div>Date: ${schedule.travelDate || 'N/A'}</div>
                                <div>Time: ${schedule.startTime || 'N/A'} - ${schedule.endTime || 'N/A'}</div>
                            </div>
                            <div>
                                <div>Bus: ${bus.registrationNo || 'N/A'}</div>
                                <div>Tickets: ${booking.bookedTickets || 1}</div>
                                <div>Fare: Rs. ${schedule.fare || 'N/A'}</div>
                                <div>Total: Rs. ${(schedule.fare * (booking.bookedTickets || 1)) || 'N/A'}</div>
                            </div>
                        </div>
                    `;
                    
                    bookingsContainer.appendChild(bookingItem);
                });
                
                userBox.appendChild(userHeader);
                userBox.appendChild(bookingsContainer);
                container.appendChild(userBox);
            });
        }

        function filterBookings() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayBookings();
                return;
            }
            
            const filteredBookings = bookings.filter(booking => {
                const user = users.find(u => u.email === booking.email);
                const userName = user ? `${user.firstName} ${user.lastName}`.toLowerCase() : '';
                const email = booking.email.toLowerCase();
                const bookingId = booking.bookingId.toString();
                
                return userName.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       bookingId.includes(searchTerm);
            });
            
            // Temporarily replace bookings array for display
            const originalBookings = bookings;
            bookings = filteredBookings;
            displayBookings();
            bookings = originalBookings;
        }

        function clearSearch() {
            document.getElementById('searchBox').value = '';
            displayBookings();
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error' : 'success';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }




    </script>
</body>
</html>
